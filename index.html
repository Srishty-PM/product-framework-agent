<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product Intelligence Agent</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #080c14;
      --surface: #0d1421;
      --surface2: #09101c;
      --border: #1e293b;
      --border-dim: #131c2e;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --text-dim: #64748b;
      --text-faint: #475569;
      --text-ghost: #334155;
      --accent: #0EA5E9;
      --green: #10B981;
      --amber: #F59E0B;
      --purple: #8B5CF6;
      --red: #EF4444;
      --font: 'DM Mono', 'Fira Code', 'Courier New', monospace;
      --serif: 'Instrument Serif', Georgia, serif;
    }

    html { scroll-behavior: smooth; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      min-height: 100vh;
      font-size: 14px;
    }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: #0f1624; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }

    /* HEADER */
    .header {
      border-bottom: 1px solid var(--border);
      padding: 1.25rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-label { font-size: 0.6rem; letter-spacing: 0.2em; color: var(--text-faint); text-transform: uppercase; margin-bottom: 0.2rem; }
    .header-title { font-family: var(--serif); font-size: 1.15rem; color: #f1f5f9; font-style: italic; }
    .progress-wrap { display: flex; align-items: center; gap: 0.75rem; }
    .progress-bar-track { width: 160px; height: 2px; background: var(--border); border-radius: 1px; overflow: hidden; }
    .progress-bar-fill { height: 100%; background: var(--accent); border-radius: 1px; transition: width 0.5s ease; width: 0%; }
    .progress-label { font-size: 0.6rem; color: var(--text-dim); letter-spacing: 0.1em; }

    /* MAIN */
    .main { max-width: 900px; margin: 0 auto; padding: 2rem; }

    /* API KEY */
    .api-section { border: 1px solid var(--border-dim); border-radius: 4px; padding: 1.25rem 1.5rem; margin-bottom: 1.25rem; background: var(--surface2); }
    .api-section.unlocked { border-color: #14532d; background: #0a1a12; }
    .section-label { font-size: 0.6rem; letter-spacing: 0.2em; color: var(--text-faint); text-transform: uppercase; margin-bottom: 0.6rem; }
    .api-row { display: flex; gap: 0.75rem; align-items: center; }
    .api-input { flex: 1; background: transparent; border: 1px solid var(--border); border-radius: 3px; color: var(--text); font-family: var(--font); font-size: 0.78rem; padding: 0.5rem 0.75rem; letter-spacing: 0.05em; }
    .api-input:focus { outline: none; border-color: var(--accent); }
    .api-hint { font-size: 0.58rem; color: var(--text-dim); margin-top: 0.5rem; letter-spacing: 0.05em; }
    .api-hint a { color: var(--accent); text-decoration: none; }
    .api-hint a:hover { text-decoration: underline; }
    .unlocked-badge { font-size: 0.6rem; color: var(--green); letter-spacing: 0.15em; text-transform: uppercase; }

    /* PROBLEM */
    .problem-section { border: 1px solid var(--border); border-radius: 4px; padding: 1.5rem; margin-bottom: 2rem; background: var(--surface); }
    .problem-textarea { width: 100%; background: transparent; border: none; color: var(--text); font-family: var(--font); font-size: 0.88rem; line-height: 1.6; padding: 0; resize: none; }
    .problem-textarea:focus { outline: none; }
    .problem-textarea::placeholder { color: var(--text-ghost); }
    .problem-textarea:disabled { opacity: 0.5; }
    .btn-row { margin-top: 1.25rem; display: flex; gap: 0.75rem; }

    /* BUTTONS */
    .btn { border: none; padding: 0.6rem 1.5rem; border-radius: 3px; font-size: 0.68rem; letter-spacing: 0.15em; text-transform: uppercase; cursor: pointer; font-family: var(--font); transition: opacity 0.2s, transform 0.1s; }
    .btn:hover { opacity: 0.85; }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:disabled { opacity: 0.35; cursor: not-allowed; }
    .btn-stop { background: transparent; color: var(--red); border: 1px solid var(--red); }
    .btn-amber { background: var(--amber); color: #000; }
    .btn-purple { background: var(--purple); color: #fff; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
    .btn-sm { padding: 0.4rem 1rem; font-size: 0.62rem; }

    /* STEP CARDS */
    .steps { display: flex; flex-direction: column; gap: 1px; }
    .step-card { border: 1px solid var(--border-dim); border-radius: 3px; background: var(--surface2); transition: border-color 0.3s, background 0.3s; overflow: hidden; }
    .step-card:hover { border-color: var(--border) !important; }
    .step-card.running { background: rgba(14,165,233,0.04); }
    .step-card.completed { background: var(--surface); border-color: var(--border); }
    .step-header { padding: 1rem 1.25rem; display: flex; align-items: center; gap: 1rem; cursor: default; }
    .step-header.clickable { cursor: pointer; }
    .step-indicator { flex-shrink: 0; width: 20px; text-align: center; font-size: 0.75rem; }
    .step-info { flex: 1; }
    .step-name { font-size: 0.68rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-ghost); transition: color 0.3s; }
    .step-name.active { color: var(--accent); }
    .step-name.done { color: var(--text-muted); }
    .step-generating { font-size: 0.58rem; color: var(--text-faint); margin-top: 0.2rem; letter-spacing: 0.1em; }
    .step-chevron { color: var(--text-ghost); font-size: 0.7rem; transition: transform 0.2s; }
    .step-chevron.open { transform: rotate(180deg); }
    .step-content { border-top: 1px solid var(--border); padding: 1.25rem 1.5rem 1.5rem; font-size: 0.81rem; line-height: 1.7; display: none; animation: slideIn 0.35s ease forwards; }
    .step-content.visible { display: block; }
    .step-accent-bar { width: 2rem; height: 2px; margin-bottom: 1rem; border-radius: 1px; }

    .result-header { color: var(--text-muted); font-size: 0.68rem; letter-spacing: 0.12em; text-transform: uppercase; margin: 1rem 0 0.4rem; font-weight: 600; }
    .result-bullet { display: flex; gap: 0.5rem; margin: 0.25rem 0; padding-left: 0.5rem; }
    .result-bullet-dash { color: var(--text-dim); flex-shrink: 0; }
    .result-bullet-text { color: #e2e8f0; line-height: 1.6; }
    .result-numbered { display: flex; gap: 0.5rem; margin: 0.3rem 0; padding-left: 0.5rem; }
    .result-num { color: var(--text-muted); flex-shrink: 0; font-size: 0.78rem; padding-top: 2px; }
    .result-p { color: #cbd5e1; line-height: 1.7; margin: 0.2rem 0; }

    /* DONE BANNER */
    .done-banner { margin-top: 2rem; border: 1px solid #14532d; border-radius: 3px; padding: 1.25rem 1.5rem; background: #0a1a12; display: flex; align-items: center; justify-content: space-between; animation: slideIn 0.4s ease forwards; }
    .done-label { font-size: 0.58rem; letter-spacing: 0.2em; color: #16a34a; text-transform: uppercase; margin-bottom: 0.25rem; }
    .done-text { font-size: 0.78rem; color: #4ade80; }
    .done-count { font-size: 0.62rem; color: #166534; letter-spacing: 0.1em; }

    .error-banner { margin-top: 1rem; border: 1px solid #7f1d1d; border-radius: 3px; padding: 1rem 1.25rem; background: #0f0a0a; font-size: 0.73rem; color: #f87171; letter-spacing: 0.04em; }

    /* ── STEP 12: DELIVERABLES ─────────────────────────────── */
    .deliverables-section { margin-top: 2rem; animation: slideIn 0.5s ease forwards; }
    .deliverables-heading { font-size: 0.6rem; letter-spacing: 0.2em; color: var(--text-faint); text-transform: uppercase; margin-bottom: 1rem; padding-left: 0.25rem; }
    .deliverables-intro { font-size: 0.75rem; color: var(--text-dim); margin-bottom: 1.25rem; line-height: 1.5; }
    .deliverables-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; }
    @media (max-width: 600px) { .deliverables-grid { grid-template-columns: 1fr; } }

    .deliverable-card { border: 1px solid var(--border-dim); border-radius: 3px; background: var(--surface2); overflow: hidden; transition: border-color 0.3s; }
    .deliverable-card:hover { border-color: var(--border); }
    .deliverable-card.generating-proto { border-color: var(--amber); background: rgba(245,158,11,0.04); }
    .deliverable-card.generating-prd { border-color: var(--purple); background: rgba(139,92,246,0.04); }
    .deliverable-card.card-done { border-color: var(--border); background: var(--surface); }

    .deliverable-header { padding: 1.25rem 1.25rem 1rem; }
    .deliverable-icon { font-size: 1.4rem; margin-bottom: 0.6rem; }
    .deliverable-title { font-size: 0.72rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.3rem; }
    .deliverable-desc { font-size: 0.71rem; color: var(--text-dim); line-height: 1.5; }
    .deliverable-actions { padding: 0 1.25rem 1.25rem; display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    .deliverable-status { font-size: 0.6rem; color: var(--text-dim); letter-spacing: 0.08em; }

    /* PROTOTYPE PREVIEW */
    .prototype-preview { margin: 0 1.25rem 1.25rem; border: 1px solid var(--border); border-radius: 3px; overflow: hidden; }
    .prototype-preview-bar { background: #111827; padding: 0.5rem 0.75rem; display: flex; align-items: center; gap: 0.4rem; border-bottom: 1px solid var(--border); }
    .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .dot-red { background: #EF4444; }
    .dot-amber { background: #F59E0B; }
    .dot-green { background: #10B981; }
    .prototype-frame { width: 100%; height: 400px; border: none; background: #fff; display: block; }

    /* PRD PREVIEW */
    .prd-preview { margin: 0 1.25rem 1.25rem; border: 1px solid var(--border); border-radius: 3px; background: var(--bg); padding: 1rem 1.25rem; max-height: 400px; overflow-y: auto; font-size: 0.78rem; line-height: 1.7; }

    /* FOOTER */
    .footer { margin-top: 3rem; padding-top: 1.5rem; border-top: 1px solid var(--border-dim); display: flex; justify-content: space-between; align-items: center; }
    .footer span { font-size: 0.58rem; color: var(--border); letter-spacing: 0.13em; text-transform: uppercase; }

    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
    @keyframes slideIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
    .pulse { animation: pulse 1.4s ease-in-out infinite; }
  </style>
</head>
<body>

<header class="header">
  <div>
    <div class="header-label">Product Intelligence Agent</div>
    <div class="header-title">Framework Runner</div>
  </div>
  <div id="headerRight"></div>
</header>

<main class="main">

  <!-- API KEY -->
  <div class="api-section" id="apiSection">
    <div class="section-label">Anthropic API Key</div>
    <div class="api-row">
      <input type="password" class="api-input" id="apiKeyInput" placeholder="sk-ant-..." />
      <button class="btn btn-primary" onclick="saveApiKey()">Unlock</button>
    </div>
    <div class="api-hint">
      Your key stays in your browser only — never stored or shared. Get a free key (includes $5 credit) at <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a>
    </div>
  </div>

  <!-- PROBLEM STATEMENT -->
  <div class="problem-section">
    <div class="section-label">Problem Statement</div>
    <textarea id="problemInput" class="problem-textarea" rows="3" placeholder="Enter the problem statement..."></textarea>
    <div class="btn-row" id="btnRow">
      <button class="btn btn-primary" id="runBtn" onclick="runFramework()" disabled>▶ Run Framework</button>
    </div>
  </div>

  <!-- STEPS 1–11 -->
  <div class="steps" id="stepsContainer"></div>

  <!-- DONE / ERROR -->
  <div id="doneBanner" style="display:none"></div>
  <div id="errorBanner" style="display:none" class="error-banner"></div>

  <!-- STEP 11: DELIVERABLES (always visible, unlocks after framework runs) -->
  <div id="deliverablesSection" class="deliverables-section">
    <div class="deliverables-heading">11 — Generate Deliverables</div>
    <div class="deliverables-intro" id="deliverablesIntro">Run the framework above to unlock prototype and PRD generation.</div>
    <div class="deliverables-grid">

      <!-- PROTOTYPE -->
      <div class="deliverable-card" id="protoCard">
        <div class="deliverable-header">
          <div class="deliverable-icon" id="protoIcon" style="opacity:0.3">⬡</div>
          <div class="deliverable-title">Interactive Prototype</div>
          <div class="deliverable-desc">A clickable HTML mockup of the top solution built from your full framework output. Download and open in any browser.</div>
        </div>
        <div class="deliverable-actions" id="protoActions">
          <button class="btn btn-amber btn-sm" id="protoBtn" onclick="generatePrototype()" disabled style="opacity:0.35;cursor:not-allowed">▶ Yes, Generate Prototype</button>
        </div>
      </div>

      <!-- PRD -->
      <div class="deliverable-card" id="prdCard">
        <div class="deliverable-header">
          <div class="deliverable-icon" id="prdIcon" style="opacity:0.3">◧</div>
          <div class="deliverable-title">Product Requirements Doc</div>
          <div class="deliverable-desc">A structured PRD with user stories, requirements, and success metrics — ready to share with engineers or stakeholders.</div>
        </div>
        <div class="deliverable-actions" id="prdActions">
          <button class="btn btn-purple btn-sm" id="prdBtn" onclick="generatePRD()" disabled style="opacity:0.35;cursor:not-allowed">▶ Yes, Generate PRD</button>
        </div>
      </div>

    </div>
  </div>

  <!-- FOOTER -->
  <div class="footer">
    <span>Powered by Claude — Anthropic</span>
    <span>Segments → Pain Points → Problem → Hypothesis → Solutions → ML → Data → RICE → Risks → Metrics → Deliverables</span>
  </div>

</main>

<script>
// ─── STATE ────────────────────────────────────────────────────────────────────
let apiKey = '';
let abortFlag = false;
let status = 'idle';
let results = {};
let completedSteps = [];
let expandedStep = null;

const STEP_COLORS = [
  '#0EA5E9','#8B5CF6','#EC4899','#F59E0B',
  '#10B981','#6366F1','#F97316','#3B82F6',
  '#EF4444','#14B8A6','#A855F7'
];

// ─── FRAMEWORK STEPS ─────────────────────────────────────────────────────────
const STEPS = [
  {
    id: 'segments', label: '01 — Customer Segments', icon: '◎',
    prompt: (p) => `You are a senior PM in a product interview. Given: "${p}"

Name 3-4 customer segments. For each, give ONE line only:
Format: [Segment name] — [who they are] | Behaviour: [key trait] | Motivation: [why they care]

Be specific and behavioural. No paragraphs. Max 4 segments. Total response under 150 words.`
  },
  {
    id: 'painpoints', label: '02 — Pain Points by Segment', icon: '⚡',
    prompt: (p, prev) => `You are a senior PM in a product interview. Segments: ${prev.segments}

For each segment, list 2 pain points only. Format:
[Segment]: 
- [Pain point name]: [one sentence on why it hurts] [High/Med/Low]

Skip intros. Max 120 words total.`
  },
  {
    id: 'problemstatement', label: '03 — Problem Statement', icon: '◐',
    prompt: (p, prev) => `You are a senior PM in a product interview. Given: "${p}"
Segments: ${prev.segments}

Write ONE crisp problem statement (2-3 sentences max) using:
"[Who] can't [do X] because [root cause]. This costs them [consequence]. We're uniquely positioned to solve this because [platform's unique advantage]."

Then ONE sentence: why now? Max 80 words total.`
  },
  {
    id: 'hypothesis', label: '04 — Hypothesis', icon: '◈',
    prompt: (p, prev) => `You are a senior PM in a product interview.
Problem: ${prev.problemstatement}

Write 2 testable hypotheses only. Format:
"We believe [X] because [signal]. Validated if [metric]."

One on user behaviour, one on the product mechanism. Label which is Priority 1 and why in one sentence. Max 100 words.`
  },
  {
    id: 'solutions', label: '05 — Solution Options', icon: '◆',
    prompt: (p, prev) => `You are a senior PM in a product interview. Given: "${p}"

List 4 solutions. For each use EXACTLY this format:
[Name] | Segment: X | Complexity: Low/Med/High | Value: Quick/Medium/Long | Type: Incremental/Differentiated/Category-creating
→ [One sentence: what it does and why it's interesting]

Include one ML/data-moat solution. No paragraphs. Max 150 words.`
  },
  {
    id: 'ml_opportunities', label: '06 — ML Opportunity Mapping', icon: '◈',
    prompt: (p, prev) => `You are a senior PM who understands ML. Solutions: ${prev.solutions}

For each solution, one line:
[Solution] | ML needed? Yes/No/Optional | If yes: [ML type] | Data moat: [what this platform has that competitors don't]

Then pick the TOP ML bet and write 2 sentences: what it predicts, and why it's defensible. Max 120 words total.`
  },
  {
    id: 'data_strategy', label: '07 — Data & Feature Strategy', icon: '◆',
    prompt: (p, prev) => `You are a senior PM who understands ML. Top ML solution: ${prev.ml_opportunities}

List 5 concrete features only (be specific, e.g. "avg claim rate in same postcode over 24 months").
Flag any proxy risks for protected characteristics inline with ⚠.

Then 2 sentences on cold start: how do you handle new users with no history?

Max 100 words.`
  },
  {
    id: 'prioritisation', label: '08 — RICE Prioritisation', icon: '◉',
    prompt: (p, prev) => `You are a senior PM in a product interview. Solutions: ${prev.solutions}

Score each using RICE (Reach × Impact × Confidence / Effort, all 1-10):
| Solution | R | I | C | E | Score |

Then ONE sentence: what's your recommended sequencing and why. Max 100 words.`
  },
  {
    id: 'tradeoffs', label: '09 — Tradeoffs & Risks', icon: '◯',
    prompt: (p, prev) => `You are a senior PM in a product interview. Top solutions: ${prev.prioritisation}

For the top 2 solutions only, give 2 risks each:
[Solution]:
- [Risk type]: [one sentence — be specific and frank]
- [Risk type]: [one sentence]

Risk types: Technical, ML, Adoption, Regulatory, Competitive. Max 100 words.`
  },
  {
    id: 'metrics', label: '10 — Success Metrics', icon: '◎',
    prompt: (p, prev) => `You are a senior PM in a product interview. Given: "${p}"

Bullet format only:
NORTH STAR: [metric name] — [one line why]
LEADING (2): [metric] — [what it signals]
LAGGING (2): [metric] — [what it confirms]
GUARDRAIL (1): [metric] — [what it protects]

End with: "Monday morning I'd check: [X]"

Max 100 words. No extra headers.`
  }
];

// ─── API KEY ──────────────────────────────────────────────────────────────────
function saveApiKey() {
  const val = document.getElementById('apiKeyInput').value.trim();
  if (!val.startsWith('sk-')) { alert('Please enter a valid Anthropic API key (starts with sk-)'); return; }
  apiKey = val;
  const section = document.getElementById('apiSection');
  section.classList.add('unlocked');
  section.innerHTML = `<div class="section-label">API Key</div><div class="unlocked-badge">✓ Unlocked — ready to run</div>`;
  updateRunBtn();
}

function updateRunBtn() {
  const btn = document.getElementById('runBtn');
  if (!btn) return;
  const problem = document.getElementById('problemInput').value.trim();
  btn.disabled = !apiKey || !problem || status === 'running';
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('problemInput').addEventListener('input', updateRunBtn);
  renderSteps();
});

// ─── RENDER STEPS ─────────────────────────────────────────────────────────────
function renderSteps() {
  const container = document.getElementById('stepsContainer');
  container.innerHTML = '';
  STEPS.forEach((step, idx) => {
    const color = STEP_COLORS[idx];
    const div = document.createElement('div');
    div.className = 'step-card';
    div.id = `card-${step.id}`;
    div.innerHTML = `
      <div class="step-header" id="header-${step.id}">
        <div class="step-indicator" id="indicator-${step.id}"><span style="color:#1e293b">${step.icon}</span></div>
        <div class="step-info"><div class="step-name" id="name-${step.id}">${step.label}</div></div>
      </div>
      <div class="step-content" id="content-${step.id}">
        <div class="step-accent-bar" style="background:${color}"></div>
        <div id="result-${step.id}"></div>
      </div>`;
    container.appendChild(div);
  });
}

function markRunning(stepId, color) {
  const card = document.getElementById(`card-${stepId}`);
  card.className = 'step-card running';
  card.style.borderColor = color;
  document.getElementById(`indicator-${stepId}`).innerHTML = `<span class="pulse" style="color:${color}">◉</span>`;
  const nameEl = document.getElementById(`name-${stepId}`);
  nameEl.className = 'step-name active';
  if (!nameEl.parentElement.querySelector('.step-generating')) {
    const g = document.createElement('div');
    g.className = 'step-generating'; g.textContent = 'Generating...';
    nameEl.parentElement.appendChild(g);
  }
}

function markCompleted(stepId, color, text) {
  const card = document.getElementById(`card-${stepId}`);
  card.className = 'step-card completed'; card.style.borderColor = '#1e293b';
  document.getElementById(`indicator-${stepId}`).innerHTML = `<span style="color:${color}">✓</span>`;
  const nameEl = document.getElementById(`name-${stepId}`);
  nameEl.className = 'step-name done';
  const g = nameEl.parentElement.querySelector('.step-generating');
  if (g) g.remove();
  document.getElementById(`result-${stepId}`).innerHTML = formatResult(text);
  const header = document.getElementById(`header-${stepId}`);
  header.classList.add('clickable');
  if (!header.querySelector('.step-chevron')) {
    const chev = document.createElement('span');
    chev.className = 'step-chevron open'; chev.textContent = '▾';
    header.appendChild(chev);
  }
  header.onclick = () => toggleStep(stepId);
  expandStep(stepId);
}

function expandStep(id) {
  if (expandedStep && expandedStep !== id) collapseStep(expandedStep);
  expandedStep = id;
  document.getElementById(`content-${id}`).classList.add('visible');
  const c = document.getElementById(`header-${id}`).querySelector('.step-chevron');
  if (c) c.classList.add('open');
}

function collapseStep(id) {
  document.getElementById(`content-${id}`).classList.remove('visible');
  const c = document.getElementById(`header-${id}`).querySelector('.step-chevron');
  if (c) c.classList.remove('open');
}

function toggleStep(id) {
  if (expandedStep === id) { collapseStep(id); expandedStep = null; }
  else expandStep(id);
}

// ─── FORMAT RESULT ────────────────────────────────────────────────────────────
function formatResult(text) {
  return text.split('\n').map(line => {
    if (!line.trim()) return '<div style="height:0.5rem"></div>';
    if (line.startsWith('- ') || line.startsWith('• '))
      return `<div class="result-bullet"><span class="result-bullet-dash">—</span><span class="result-bullet-text">${escHtml(line.replace(/^[-•]\s/,'').replace(/\*\*/g,''))}</span></div>`;
    if (/^\d+\.\s/.test(line)) {
      const num = line.match(/^\d+/)[0];
      return `<div class="result-numbered"><span class="result-num">${num}.</span><span class="result-bullet-text">${escHtml(line.replace(/^\d+\.\s/,'').replace(/\*\*/g,''))}</span></div>`;
    }
    const clean = line.replace(/\*\*/g,'');
    const isH = line.startsWith('#') || (line.endsWith(':') && line.length < 60 && !line.startsWith(' '));
    if (isH) return `<div class="result-header">${escHtml(clean.replace(/^#+\s/,''))}</div>`;
    return `<p class="result-p">${escHtml(clean)}</p>`;
  }).join('');
}

// markdown-aware formatter for PRD
function formatPRD(text) {
  return text.split('\n').map(line => {
    if (!line.trim()) return '<div style="height:0.4rem"></div>';
    if (line.startsWith('# ')) return `<div style="color:#f1f5f9;font-size:0.9rem;font-family:var(--serif);font-style:italic;margin:0.5rem 0 0.75rem">${escHtml(line.replace(/^#\s/,''))}</div>`;
    if (line.startsWith('## ')) return `<div style="color:#8B5CF6;font-size:0.65rem;letter-spacing:0.15em;text-transform:uppercase;margin:1rem 0 0.4rem;font-weight:600;border-top:1px solid #1e293b;padding-top:0.75rem">${escHtml(line.replace(/^##\s/,''))}</div>`;
    if (line.startsWith('- ') || line.startsWith('• '))
      return `<div class="result-bullet"><span class="result-bullet-dash">—</span><span class="result-bullet-text">${escHtml(line.replace(/^[-•]\s/,'').replace(/\*\*/g,''))}</span></div>`;
    if (/^\d+\.\s/.test(line)) {
      const num = line.match(/^\d+/)[0];
      return `<div class="result-numbered"><span class="result-num">${num}.</span><span class="result-bullet-text">${escHtml(line.replace(/^\d+\.\s/,'').replace(/\*\*/g,''))}</span></div>`;
    }
    return `<p class="result-p">${escHtml(line.replace(/\*\*/g,''))}</p>`;
  }).join('');
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ─── PROGRESS BAR ─────────────────────────────────────────────────────────────
function updateHeader() {
  const hr = document.getElementById('headerRight');
  if (status === 'running') {
    const pct = (completedSteps.length / STEPS.length * 100).toFixed(0);
    hr.innerHTML = `<div class="progress-wrap"><div class="progress-bar-track"><div class="progress-bar-fill" style="width:${pct}%"></div></div><span class="progress-label">${completedSteps.length}/${STEPS.length}</span></div>`;
  } else if (status === 'done') {
    hr.innerHTML = `<span style="font-size:0.65rem;letter-spacing:0.15em;text-transform:uppercase;color:#10B981">✓ Complete</span>`;
  } else {
    hr.innerHTML = '';
  }
}

// ─── CALL CLAUDE ──────────────────────────────────────────────────────────────
async function callClaude(prompt, maxTokens = 400) {
  const res = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'anthropic-version': '2023-06-01', 'x-api-key': apiKey },
    body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: maxTokens, messages: [{ role: 'user', content: prompt }] })
  });
  const data = await res.json();
  if (!res.ok || data.error) throw new Error(data.error?.message || `HTTP ${res.status}`);
  return data.content.map(b => b.text || '').join('');
}

// ─── RUN FRAMEWORK ────────────────────────────────────────────────────────────
async function runFramework() {
  abortFlag = false; status = 'running'; results = {}; completedSteps = []; expandedStep = null;
  document.getElementById('doneBanner').style.display = 'none';
  document.getElementById('errorBanner').style.display = 'none';
  document.getElementById('deliverablesSection').style.display = 'none';
  document.getElementById('problemInput').disabled = true;
  document.getElementById('btnRow').innerHTML = `<button class="btn btn-stop" onclick="stopFramework()">■ Stop</button>`;
  renderSteps();
  updateHeader();

  const problem = document.getElementById('problemInput').value.trim();
  const accumulated = {};

  for (let i = 0; i < STEPS.length; i++) {
    if (abortFlag) break;
    const step = STEPS[i];
    markRunning(step.id, STEP_COLORS[i]);
    try {
      const prompt = step.prompt(problem, accumulated);
      const result = await callClaude(prompt);
      accumulated[step.id] = result;
      results[step.id] = result;
      completedSteps.push(step.id);
      markCompleted(step.id, STEP_COLORS[i], result);
      updateHeader();
    } catch (err) {
      const eb = document.getElementById('errorBanner');
      eb.style.display = 'block';
      eb.textContent = `⚠ ${err.message || 'API error — check your key and connection'}`;
      status = 'error'; resetControls(); return;
    }
  }

  status = 'done';
  updateHeader();

  const done = document.getElementById('doneBanner');
  done.style.display = 'flex';
  done.innerHTML = `<div><div class="done-label">Framework Complete</div><div class="done-text">All ${STEPS.length} stages generated — click any section to review</div></div><div class="done-count">${STEPS.length} / ${STEPS.length} ✓</div>`;

  // Unlock deliverables section
  document.getElementById('deliverablesIntro').textContent = 'Framework complete. Generate a prototype or PRD from your analysis — click either to start.';
  document.getElementById('protoBtn').disabled = false;
  document.getElementById('protoBtn').style.opacity = '1';
  document.getElementById('protoBtn').style.cursor = 'pointer';
  document.getElementById('prdBtn').disabled = false;
  document.getElementById('prdBtn').style.opacity = '1';
  document.getElementById('prdBtn').style.cursor = 'pointer';
  document.getElementById('protoIcon').style.opacity = '1';
  document.getElementById('prdIcon').style.opacity = '1';

  resetControls();
}

function stopFramework() { abortFlag = true; status = 'idle'; resetControls(); }

function resetControls() {
  document.getElementById('problemInput').disabled = false;
  document.getElementById('btnRow').innerHTML = `<button class="btn btn-primary" id="runBtn" onclick="runFramework()">${completedSteps.length > 0 ? '↺ Run Again' : '▶ Run Framework'}</button>`;
  updateRunBtn();
}

// ─── GENERATE PROTOTYPE ───────────────────────────────────────────────────────
async function generatePrototype() {
  const card = document.getElementById('protoCard');
  const actions = document.getElementById('protoActions');
  card.className = 'deliverable-card generating-proto';
  actions.innerHTML = `<span class="pulse" style="color:#F59E0B;font-size:0.8rem">◉</span><span class="deliverable-status"> Building prototype...</span>`;

  const problem = document.getElementById('problemInput').value.trim();
  const prompt = `You are a senior product designer and frontend engineer.

Build a complete, self-contained interactive HTML prototype for this product:

PROBLEM: ${problem}
TOP SOLUTION (from RICE analysis): ${results.prioritisation || ''}
TARGET USERS: ${results.segments || ''}
CORE PAIN POINTS: ${results.painpoints || ''}

Requirements:
- Single HTML file, all CSS and JS inline — zero external dependencies
- Show 2-3 key screens/states of the core user flow, switchable via a tab bar or nav buttons
- Use a clean, modern, professional design with a cohesive colour palette
- Fill with realistic, domain-specific placeholder content (not lorem ipsum)
- Make it feel like a real product UI, not a wireframe
- Add subtle hover states and transitions
- ONLY output raw HTML starting with <!DOCTYPE html> — no explanation, no markdown, no code fences`;

  try {
    const html = await callClaude(prompt, 4000);
    const match = html.match(/<!DOCTYPE html>[\s\S]*/i) || html.match(/<html[\s\S]*/i);
    const cleanHtml = match ? match[0] : html;

    card.className = 'deliverable-card card-done';

    const preview = document.createElement('div');
    preview.className = 'prototype-preview';
    preview.innerHTML = `
      <div class="prototype-preview-bar">
        <div class="dot dot-red"></div>
        <div class="dot dot-amber"></div>
        <div class="dot dot-green"></div>
        <span style="font-size:0.6rem;color:#475569;margin-left:0.75rem;letter-spacing:0.05em">prototype preview</span>
      </div>
      <iframe class="prototype-frame" id="protoFrame"></iframe>`;
    card.insertBefore(preview, actions);

    const iframe = document.getElementById('protoFrame');
    iframe.contentDocument.open();
    iframe.contentDocument.write(cleanHtml);
    iframe.contentDocument.close();

    actions.innerHTML = `
      <button class="btn btn-amber btn-sm" onclick="downloadFile('prototype.html', protoHtmlStore)">↓ Download HTML</button>
      <span class="deliverable-status" style="color:#10B981">✓ Generated</span>`;
    window.protoHtmlStore = cleanHtml;

  } catch (err) {
    card.className = 'deliverable-card';
    actions.innerHTML = `<button class="btn btn-amber btn-sm" onclick="generatePrototype()">↺ Retry</button><span class="deliverable-status" style="color:#EF4444"> ⚠ ${escHtml(err.message)}</span>`;
  }
}

// ─── GENERATE PRD ─────────────────────────────────────────────────────────────
async function generatePRD() {
  const card = document.getElementById('prdCard');
  const actions = document.getElementById('prdActions');
  card.className = 'deliverable-card generating-prd';
  actions.innerHTML = `<span class="pulse" style="color:#8B5CF6;font-size:0.8rem">◉</span><span class="deliverable-status"> Writing PRD...</span>`;

  const problem = document.getElementById('problemInput').value.trim();
  const prompt = `You are a senior PM writing a PRD for engineers and stakeholders.

Based on this complete product analysis:
PROBLEM: ${problem}
SEGMENTS: ${results.segments || ''}
PAIN POINTS: ${results.painpoints || ''}
PROBLEM STATEMENT: ${results.problemstatement || ''}
HYPOTHESES: ${results.hypothesis || ''}
SOLUTIONS: ${results.solutions || ''}
PRIORITISATION: ${results.prioritisation || ''}
RISKS: ${results.tradeoffs || ''}
METRICS: ${results.metrics || ''}

Write a structured PRD using EXACTLY this format:

# Product Requirements Document

## Overview
[2-3 sentence summary of what we're building and why]

## Problem Statement
[From the analysis above, 2-3 sentences]

## Target Users
[Top 2 segments, one line each]

## Goals & Success Metrics
[North star metric + 2 leading + 2 lagging]

## Scope — What We're Building (v1)
[Top 2 prioritised solutions with brief feature list]

## User Stories
[5 user stories: As a [user], I want [action] so that [outcome]]

## Functional Requirements
[8 numbered requirements, specific and testable]

## Out of Scope (v1)
[3 things explicitly excluded with one-line reason]

## Risks & Mitigations
[Top 3 risks with one-line mitigation each]

## Open Questions
[3 questions that need answering before build starts]

Keep it tight, specific, and actionable. No filler.`;

  try {
    const prd = await callClaude(prompt, 2500);
    card.className = 'deliverable-card card-done';

    const preview = document.createElement('div');
    preview.className = 'prd-preview';
    preview.innerHTML = formatPRD(prd);
    card.insertBefore(preview, actions);

    window.prdStore = prd;
    actions.innerHTML = `
      <button class="btn btn-purple btn-sm" onclick="downloadFile('PRD.md', prdStore)">↓ Download .md</button>
      <button class="btn btn-outline btn-sm" onclick="copyText(prdStore)">⊕ Copy</button>
      <span class="deliverable-status" style="color:#10B981">✓ Generated</span>`;

  } catch (err) {
    card.className = 'deliverable-card';
    actions.innerHTML = `<button class="btn btn-purple btn-sm" onclick="generatePRD()">↺ Retry</button><span class="deliverable-status" style="color:#EF4444"> ⚠ ${escHtml(err.message)}</span>`;
  }
}

// ─── UTILS ────────────────────────────────────────────────────────────────────
function downloadFile(filename, content) {
  const blob = new Blob([content], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function copyText(text) {
  navigator.clipboard.writeText(text).then(() => alert('Copied to clipboard!'));
}
</script>
</body>
</html>
